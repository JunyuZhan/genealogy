# 宗族数字化平台 (Clan genealogy & Cemetery System) 需求文档

## 1. 项目概述

本系统是一个基于 Web 的宗族管理平台，核心功能是通过**按需展开的动态树状图**展示家族脉络，并集成 **GIS 地图导航**定位先祖墓冢，支持**多维度数据录入**（向上、向下、平行、独立支系）与**电子祭扫**。

**(Gemini 补充):** 系统应考虑到中国传统族谱的特殊性（如：多配偶、过继、字辈、排行），并提供除树状图外的"世系表"视图以便于阅读。

---

## 1.1 门户与用户体系

* **门户首页布局:**
    * 顶部: Logo + 系统名称 + 导航菜单（首页、族谱、祭扫、支系、**捐赠**、关于）
    * Banner: 家族全称 + 简介 + 祖训/家训
    * 功能入口: 族谱浏览、祭扫纪念（大图标 + 按钮）
    * 支系入口: 支系卡片列表展示
    * 统计概览: 家族人口（已故/在世）、支系数量、祭扫次数
    * 最新动态: 最近祭扫记录（匿名）、最新成员、公告通知
    * 底部: 版权信息、联系方式、管理员登录入口（隐蔽）

* **捐赠功能（维护网站运营）:**
    * 随喜捐赠入口（微信/支付宝）
    * **公开信息**: 捐赠人姓名、金额（必填，公开公示）
    * 捐赠意愿选择：网站运营、宗族互助、专项基金等
    * 捐赠名单与金额公示
    * 捐赠用途公示与明细

* **宗族互助倡议功能:**
    * 倡议发布（家庭困难、考学奖励、突发灾难等）
    * 自愿认捐
    * 倡议进度展示
    * 倡议公示透明

* **支系介绍页面:** 支系名称、始祖、简介、人口统计、迁居地信息
* **角色体系:**
    * 超级管理员: 全局管理
    * 家族管理员: 整个家族管理
    * **支系联系人**: 负责某支系的信息收集
    * 普通成员: 查看/祭扫
    * 访客: 只读公开信息

* **用户注册与角色分配:**
    * 注册方式: 手机号/邮箱 + 密码
    * 实名: 可选填真实姓名，不强制
    * 普通成员: 注册自动成为（无需审核）
    * 支系联系人: 需管理员审批后分配
    * 管理员: 需上级手动分配
    * 祭扫记录显示网名，保护用户隐私

* **公益事项开放参与:**
    * 捐赠：任何人可查看和参与（无需登录）
    * 倡议：任何人可查看和认捐（无需登录）
    * 祭扫：任何人可参与（记录网名）

* **信息收集流程:** 支系联系人发起信息添加申请 → 提交成员信息 → 管理员审批后生效

---

## 1.2 隐私分级

| 分类 | 含义 | 字段示例 |
|-----|-----|---------|
| **公开信息** | 不涉密，默认可见 | 姓名、世代、字辈、墓穴位置、已故状态 |
| **可选公开** | 涉密信息，用户可选择公开 | 生卒日期、配偶、照片、祭扫记录、联系方式、详细生平 |

* 在世成员：默认全部"可选公开"（需用户主动授权才显示）
* 已故成员：默认公开（可设置部分隐藏）

---

## 1.3 后台配置管理

> **所有变量均在后端配置，前端仅展示配置结果**

| 配置项 | 说明 |
|-------|------|
| 系统参数 | 系统名称、Logo、描述、联系方式 |
| 隐私策略 | 公开字段/可选公开字段的默认配置 |
| 角色权限 | 各角色功能开关（管理员后台配置） |
| 祭扫功能 | 全局开启/关闭 |
| 地图服务 | API Key、默认中心点坐标、缩放级别 |
| 世系表样式 | 默认排版模式（欧式/苏式） |
| 门户配置 | 首页展示内容、公告管理 |
| 导入配置 | CSV/Excel 字段映射、必填项定义 |

---

## 2. 技术栈建议 (Cursor 选型)

* **前端:** Vue 3 (Composition API) + Vite + Tailwind CSS
* **可视化库:** `D3.js` (核心)
    * *(Gemini 建议)*: 使用 `d3-hierarchy` 和 `d3-tree` 进行布局计算。对于复杂的家族关系（多配偶），可能需要自定义节点渲染逻辑。
* **地图服务:** Leaflet.js + OpenStreetMap (第一阶段默认实现)；高德地图 API 作为后续可选替换项
    * *(GPT 工程师修改)*: 第一阶段统一 Leaflet + OSM，避免早期分叉设计，后期再切换到高德/百度底图。
* **工具库:** 
    * `html-to-image`: 用于将族谱导出为图片 *(Gemini 新增)*
    * `dayjs`: 处理日期（需兼容农历/模糊日期） *(Gemini 新增)*
    * `lunar-javascript`: 农历日期转换 (minimax工程师新增)
* **状态管理:** Pinia (存储节点路径与搜索状态)
* **后端/数据库:** Supabase (PostgreSQL) 或 Node.js + PostgreSQL

---

## 3. 核心数据模型 (Schema) *(Gemini 修订版 | minimax工程师补充 | GPT 工程师调整)*

AI 在开发时应遵循此基础数据结构。请注意，为了兼容传统族谱，我们增强了日期和关系的定义。

*(GPT 工程师修改)*: 统一关系表达方式，children 改为 FamilyLink[]；移除 spouseOf；FamilyLink.role 增加 spouse。

```typescript
// 关系类型枚举
enum RelationshipType {
  BIOLOGICAL = 'biological',    // 血缘（亲子）
  ADOPTED = 'adopted',          // 收养/过继
  STEP = 'step',                // 继父母/继子女
  MARRIED_IN = 'married_in',   // 赘婿
}

// 家族关系边（支持双向溯源）
interface FamilyLink {
  targetId: string;            // 关联的成员ID
  relationship: RelationshipType; // 关系类型
  role: 'father' | 'mother' | 'spouse';   // 在当前节点视角中的角色
}

interface Member {
  id: string;                  // UUID
  
  // 家族定位（双向溯源，minimax工程师补充）
  parents: FamilyLink[];        // 父母关系列表（支持双亲）
  children: FamilyLink[];      // 子女关系列表（支持收养/过继）
  
  // 基础信息
  name: string;                // 姓名 (讳)
  givenName?: string;          // 字/号
  nickname?: string;           // 乳名 (minimax工程师新增)
  gender: 'M' | 'F';          
  generation: number;           // 世系序号（第几世）
  generationWord: string;     // 字辈 (派语)
  order: number;               // 排行 (如：1 为长子/长女)
  
  // 配偶信息
  spouses: Array<{
    id?: string;               // 配偶的Member ID (minimax工程师新增)
    name: string;
    maidenName?: string;       // 娘家姓
    bio?: string;             // 简略生平
    isAlive: boolean;
    marriedDate?: string;     // 结婚日期 (minimax工程师新增)
    divorcedDate?: string;    // 离异日期 (minimax工程师新增，支持多段婚姻)
    cemetery?: CemeteryInfo;
  }>;

  // 生死状态
  isAlive: boolean;           
  birthDate: string;          // 出生日期 (支持 'YYYY-MM-DD' 或 '清乾隆...' 模糊文本)
  deathDate?: string;         // 卒年
  bio?: string;               // 生平简介
  
  // 墓冢信息
  cemetery: CemeteryInfo | null;

  // 扩展标记
  branchName: string;         // 所属支系名称（如：三房）
  isFloating: boolean;        // 是否为尚未厘清辈份的孤立支系
  tags?: string[];           // 标签：['出嗣', '早殇', '迁出', '入赘', '过继']
  
  // 祭扫信息 (minimax工程师新增)
  lastVisitedAt?: string;     // 最后祭扫时间
  visitCount?: number;        // 祭扫次数
  
  // 隐私控制 (minimax工程师新增)
  publicFields?: string[];    // 公开的字段列表
}

// 用户与权限 (minimax工程师新增)
interface User {
  id: string;
  username: string;
  email: string;
  role: 'super_admin' | 'family_admin' | 'branch_contact' | 'member' | 'guest';
  branchId?: string;          // 支系联系人负责的支系
  memberId?: string;          // 关联的成员ID
}

// 信息申请 (minimax工程师新增)
interface InfoRequest {
  id: string;
  applicantId: string;        // 申请人ID
  targetMemberId?: string;     // 要添加/修改的成员ID
  data: Partial<Member>;       // 提交的数据
  status: 'pending' | 'approved' | 'rejected';
  reviewedBy?: string;
  createdAt: string;
}

// 提取复用的墓冢接口
interface CemeteryInfo {
    lat: number;              // 纬度
    lng: number;             // 经度
    address: string;          // 文字地址/山头名称
    photos: string[];         // 墓冢图片URL
    panorama?: string;        // 360度全景影像URL (minimax新增)
    cemeteryCode?: string;    // 墓号/碑文编号
}
```

---

## 4. 功能需求清单

### 4.1 动态交互族谱 (Core View)

* **按需展开:** 默认仅展示始祖（或选定节点）。点击节点展开下一层（子辈），再次点击收起。
* **节点渲染 (Gemini 优化):**
    * 节点应同时显示本人及配偶（并排显示）。
    * 不同性别、在世/离世状态应有明显的视觉区分（颜色/边框/置灰）。
* **全向扩展操作:** 点击节点弹出环形菜单：
    * `[+] 父辈`: 向上添加父母，系统自动重算当前节点及下属的所有 generation + 1。
    * `[+] 配偶`: 添加妻子/丈夫 *(Gemini 新增)*。
    * `[+] 子辈`: 向下添加子女。
    * `[+] 兄弟`: 横向添加同辈。
* **辈份对齐:** 无论支系如何展开，相同 `generation` 的节点必须在同一水平高度。
* **独立支系管理:** 支持创建"无父节点"的成员，在界面侧边栏列出，可随时通过拖拽或指定 `parentId` 归入主树。
* **成员状态变更:** 支持将在世成员标记为去世 *(minimax新增)*
    * 任何知情人可发起变更申请
    * 需管理员审核后生效
    * 变更后自动启用祭扫功能
* **支系合并:** 两个独立支系厘清关系后，可合并为一个支系 *(minimax工程师新增)*
    * 选择合并方向（主支系 + 子支系）
    * 确定子支系根节点挂在主支系的哪个节点下
    * 递归更新子支系所有后代的 generation
    * 更新 branchName，统一支系名称
    * 记录合并操作日志
    * 冲突处理：重名保留原名、代际矛盾以证据为准

### 4.2 搜索与路径穿透

* **全局检索:** 输入姓名，从数据库中匹配成员。
* **自动溯源动画:** 搜索确认后，系统从根节点开始，自动依次执行 `expand` 操作，直到定位并高亮目标节点。

### 4.3 墓冢定位与导航

* **地理锚点:** 节点详情页展示缩略地图，标注安葬位置。
* **实时导航:** 提供"手机导航"按钮，点击生成包含经纬度信息的二维码，或在移动端直接调用地图 App。
* **墓冢相册:** 支持多图上传，展示墓冢现状、碑文、航拍图。
    * 任何人可发起更新已故成员的墓冢照片/360影像
    * 需经支系联系人以上权限用户审核后才能公开显示
* **360度全景:** 支持全景影像上传与预览

### 4.4 数字化祭扫

* **祭扫入口:**
    * 成员详情页：已故成员右上角"祭扫"按钮
    * 祭扫纪念页：独立页面，可选择成员祭扫
    * 祭扫地图：在地图上直接点击墓冢祭扫

* **虚拟场景展示:** 祠堂/墓地背景、祖先遗像、生卒年份

* **交互动作与动画:**
    * 献花：虚拟花束递送动画 + 音效
    * 点烛：蜡烛点燃闪烁动画 + 背景音乐（可选）
    * 上香：香烟袅袅上升动画
    * 留言：文字输入，显示在纪念墙
    * 特效：花瓣飘落、烛光摇曳、烟雾上升

* **祭扫记录:**
    * 记录谁、何时、做了什么
    * 纪念墙匿名显示留言
    * 显示祭扫人数、最后祭扫时间
    * "XX人正在祭扫"在线状态

* **通知:**
    * 新祭扫实时推送通知
    * 祭扫纪念日提醒

### 4.5 数据导出与分享 (Gemini 新增)

* **导出图片:** 将当前展开的族谱树导出为高清 PNG/JPG。
* **世系表模式:** 提供纯文本的世系表视图（欧式/苏式排版），方便手机阅读。
* **GEDCOM 导入/导出:** 支持国际族谱交换标准格式，便于与其他族谱软件互转 (minimax工程师新增)。
* **PDF 族谱书:** 支持生成可打印的族谱PDF文档 (minimax工程师新增)。
* *(GPT 工程师修改)*: 导出能力建议分阶段交付，优先图片与世系表，GEDCOM 与 PDF 作为二期。

### 4.6 世系表视图 (minimax工程师新增)

* **欧式排版:** 横排显示，左父右子，便于阅读代际关系
* **苏式排版:** 垂直列表，按代数分组显示
* **字辈索引:** 快速查看某字辈的所有成员
* **配偶合并显示:** 子女名下显示父母双方信息

### 4.7 权限与隐私管理 (minimax工程师新增)

* **角色体系:** 超级管理员、家族管理员、支系联系人、普通成员、访客
* **隐私控制:** 公开信息 vs 可选公开，用户授权界面，导出时自动过滤
* **信息审批:** 支系联系人发起申请 → 管理员审批 → 生效
* **操作日志:** 记录所有数据修改历史

### 4.8 数据备份与迁移 (minimax工程师新增)

* **自动备份:** 定期备份数据库
* **手动导出:** 支持 JSON/SQL 格式完整导出
* **批量导入:** 支持 CSV/Excel 批量导入成员数据

### 4.9 网站安全保障 (minimax工程师新增)

* **网络层:**
    * HTTPS 全站加密传输
    * DDOS 防护与 CDN 接入
    * 请求限流（防止恶意攻击）

* **应用层:**
    * 输入验证（防止 SQL 注入、XSS）
    * 验证码（注册/登录/敏感操作）
    * 敏感操作二次确认

* **账号安全:**
    * 密码加密存储（bcrypt/argon2）
    * 登录限制（多次失败锁定）
    * Token 过期与刷新机制

* **数据安全:**
    * 定期数据备份（多地备份）
    * 操作日志记录
    * 敏感信息加密

* **监控与应急:**
    * 实时监控与异常告警
    * 应急响应机制
    * 安全审计与定期检查

---

## 5. 关键逻辑算法 (给 Cursor 的提示词)

### A. 树形布局计算 (D3.js 逻辑)

> "请使用 D3.js 的 hierarchy 和 tree 布局。注意：每个节点可能包含 'spouses' 数组，在渲染节点 SVG 时，需要根据配偶数量动态调整节点的宽度（Rect Width），确保连线（Link）始终连接到主成员（Member）的中心，而不是整个矩形的中心。" *(Gemini 修正: 处理配偶渲染)*

### B. 多维度增加节点

> "设计一个函数 `addMember(targetId, relationship)`。
> * 如果 relationship 是 'parent': 创建新节点 -> 设为 target 的 parent -> 递归更新 target 及其子孙的 generation (+1)。
> * 如果 relationship 是 'spouse': 仅更新 target 节点的 spouses 数组，不影响树结构。"

### C. 坐标关联逻辑

> "集成高德/Leaflet 地图。实现选点组件：点击地图 -> 获取 LatLng -> 逆地理编码获取地址文本 -> 回填表单。"

### D. 农历日期处理 (minimax工程师补充)

> "使用 lunar-javascript 库实现：
> * 模糊日期解析：识别 '清乾隆五十年'、'民国十五年'、'农历一九八五年正月十五' 等格式
> * 阳历农历互转：存储公历，输出时可转换为农历
> * 生卒年月日时：支持生辰八字、忌辰的精确记录"

### E. 世系表生成算法 (minimax工程师补充)

> "实现世系表渲染：
> * 欧式：按代数横向展开，父在上方，子在下方
> * 苏式：按代数纵向分页，每页一代
> * 需要处理多配偶、多子多孙的合并显示逻辑"

---

## 6. UI/UX 设计规范

* **风格:** 中式简约，背景采用淡米色（宣纸感 #F5F5DC），线条采用墨灰色 (#333)。
* **节点样式:**
    * 男性：深蓝色边框；女性：深红色边框。
    * 已故：灰色滤镜或黑白照片。
    * *(Gemini 建议)*: 字辈（GenerationWord）应在左侧纵轴或背景中隐式显示，增强代际感。
* **响应式:** Web 端适配大屏操作，手机端适配单指点击展开。

### 6.1 前端项目结构 (minimax工程师建议)

```
src/
├── components/
│   ├── family-tree/         # 族谱树核心组件
│   │   ├── FamilyTree.vue
│   │   ├── TreeNode.vue
│   │   ├── TreeLink.vue
│   │   └── ContextMenu.vue
│   ├── genealogy-table/    # 世系表视图
│   ├── map/               # 地图组件
│   ├── memorial/          # 祭扫组件
│   ├── portal/            # 门户页面 (minimax新增)
│   ├── admin/             # 管理后台 (minimax新增)
│   └── common/            # 通用组件
├── composables/            # 组合式函数
│   ├── useTree.ts
│   ├── useMembers.ts
│   └── useMap.ts
├── stores/                 # Pinia 状态管理
│   ├── memberStore.ts
│   ├── userStore.ts       # 用户与权限 (minimax新增)
│   └── uiStore.ts
├── types/                  # TypeScript 类型定义
│   └── index.ts
├── utils/                  # 工具函数
│   ├── treeBuilder.ts      # 树结构构建
│   └── gedcom.ts          # GEDCOM 格式处理
└── views/                  # 页面视图
    ├── Home.vue            # 门户首页
    ├── TreeView.vue
    ├── TableView.vue
    ├── MemberDetail.vue
    └── Admin.vue           # 管理后台
```

### 6.2 API 设计 (minimax工程师建议)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/members | 获取成员列表 |
| GET | /api/members/:id | 获取单个成员详情 |
| POST | /api/members | 创建新成员 |
| PUT | /api/members/:id | 更新成员信息 |
| DELETE | /api/members/:id | 删除成员 |
| GET | /api/members/:id/ancestors | 获取祖先路径 |
| GET | /api/members/:id/descendants | 获取后代列表 |
| POST | /api/members/:id/visit | 记录祭扫 |
| POST | /api/auth/register | 用户注册 |
| POST | /api/auth/login | 用户登录 |
| GET | /api/users | 获取用户列表 (管理员) |
| PUT | /api/users/:id/role | 修改用户角色 |
| POST | /api/requests | 提交信息申请 |
| GET | /api/requests | 获取申请列表 |
| PUT | /api/requests/:id | 审批申请 |
| GET | /api/export/gedcom | 导出 GEDCOM 格式 |
| POST | /api/import/gedcom | 导入 GEDCOM 格式 |

---

## 7. 数据库设计 (minimax工程师补充)

```sql
-- 核心表结构建议

-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) CHECK (role IN ('super_admin', 'family_admin', 'branch_contact', 'member', 'guest')) DEFAULT 'guest',
  branch_id VARCHAR(50),  -- 支系联系人负责的支系
  member_id UUID REFERENCES members(id),  -- 关联的成员ID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 成员表
CREATE TABLE members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  given_name VARCHAR(50),
  nickname VARCHAR(50),
  gender CHAR(1) CHECK (gender IN ('M', 'F')),
  generation INTEGER NOT NULL,
  generation_word VARCHAR(10),
  order_in_generation INTEGER DEFAULT 1,
  is_alive BOOLEAN DEFAULT true,
  birth_date VARCHAR(50),
  death_date VARCHAR(50),
  bio TEXT,
  branch_name VARCHAR(100),
  is_floating BOOLEAN DEFAULT false,
  tags JSONB,
  public_fields JSONB,  -- 公开的字段列表
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 家族关系表
CREATE TABLE family_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  member_id UUID REFERENCES members(id),
  target_id UUID REFERENCES members(id),
  relationship VARCHAR(20) CHECK (relationship IN ('biological', 'adopted', 'step', 'married_in')),
  role VARCHAR(10) CHECK (role IN ('father', 'mother', 'spouse'))
);

-- 配偶表
CREATE TABLE spouses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  member_id UUID REFERENCES members(id),
  name VARCHAR(100),
  maiden_name VARCHAR(50),
  is_alive BOOLEAN DEFAULT true,
  bio TEXT,
  married_date VARCHAR(50),
  divorced_date VARCHAR(50)
);

-- 墓冢表
CREATE TABLE cemeteries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  member_id UUID REFERENCES members(id) UNIQUE,
  lat DECIMAL(10, 8),
  lng DECIMAL(11, 8),
  address VARCHAR(255),
  photos JSONB,
  cemetery_code VARCHAR(50)
);

-- 祭扫日志表
CREATE TABLE memorial_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  member_id UUID REFERENCES members(id),
  action VARCHAR(20) CHECK (action IN ('flower', 'candle', 'visit', 'message')),
  message TEXT,
  visitor_id UUID REFERENCES users(id),
  visited_at TIMESTAMP DEFAULT NOW()
);

-- 信息申请表 (minimax新增)
CREATE TABLE info_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  applicant_id UUID REFERENCES users(id),
  target_member_id UUID REFERENCES members(id),
  data JSONB NOT NULL,
  status VARCHAR(20) CHECK (status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending',
  reviewed_by UUID REFERENCES users(id),
  review_comment TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  reviewed_at TIMESTAMP
);

-- 支系表 (minimax新增)
CREATE TABLE branches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  contact_user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- 公告表 (minimax新增)
CREATE TABLE announcements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  content TEXT,
  author_id UUID REFERENCES users(id),
  published_at TIMESTAMP DEFAULT NOW()
);
```

---

## 8. 部署方案

### 免费/低成本方案

| 方案 | 说明 | 费用 |
|-----|------|------|
| **Vercel + Supabase** | 前端 Vercel 托管，后端 Supabase | **免费** |
| **Railway + PostgreSQL** | 一键部署 Node.js + 数据库 | 免费额度够用 |
| **Cloudflare Pages** | 静态托管 + CDN | **免费** |
| **Render** | 托管 Node.js 服务 | 免费额度够用 |

### 推荐免费组合（初期）

```
前端: Vercel (免费托管 + CDN)
后端: Railway / Render (免费 Node.js)
数据库: Supabase (PostgreSQL，免费额度)
存储: Cloudflare R2 / 阿里云 OSS
域名: 阿里云/腾讯云 (约 30-60元/年)
```

### 收费方案（用户增长后）

| 方案 | 说明 | 费用 |
|-----|------|------|
| 阿里云/腾讯云 | ECS + OSS + RDS | 约 100-300元/月 |
| 独立服务器 | 阿里云/腾讯云 | 约 200-500元/月 |

### 部署阶段建议

1. **初期（用户少）**：Vercel + Supabase = **0元**
2. **中期（用户增长）**：升级到 Railway/Render + 对象存储
3. **长期**：云服务器 + CDN + 对象存储
